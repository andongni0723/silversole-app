name: Flutter Release

on:
  push:
    tags: ["v*.*.*"]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create .env
        run: |
          cat > .env <<'EOF'
          PUBLIC_SUPABASE_URL=${{ secrets.PUBLIC_SUPABASE_URL }}
          PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY=${{ secrets.PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY }}
          EOF

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Extract version from tag
        run: |
          echo "VERSION_NAME=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV
          echo "VERSION_CODE=${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV

      - name: Decode keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > ${{ github.workspace }}/release.jks

      - name: Create key.properties
        run: |
          cat > android/key.properties <<EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=${{ github.workspace }}/release.jks
          EOF

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze & Test
        run: |
          flutter analyze --no-fatal-warnings --no-fatal-infos
          flutter test

      - name: Build Release APK (signed)
        run: |
          flutter build apk --release --build-name=${{ env.VERSION_NAME }} --build-number=${{ env.VERSION_CODE }} --split-per-abi
          mv build/app/outputs/flutter-apk/app-arm64-v8a-release.apk build/app/outputs/flutter-apk/silversole_${{ env.VERSION_NAME }}_arm64-v8a-release.apk

      - name: Create GitHub Release + upload APK
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NOTES=$(awk -v ver="${GITHUB_REF_NAME}" '
            BEGIN { found=0 }
            $0 ~ "^##[[:space:]]*" ver "$" { found=1; next }
            $0 ~ "^##[[:space:]]+v" { if (found) exit }
            found { print }
          ' CHANGELOG.md)
          gh release create "${GITHUB_REF_NAME}" \
            --title "${GITHUB_REF_NAME}" \
            --notes "$NOTES" \
            build/app/outputs/flutter-apk/*arm64-v8a-release.apk
